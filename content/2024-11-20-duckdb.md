Title: DuckDB vs. Bespoke Python
Date: 2024-11-20 17:00
Author: Ryan McKay
Tags: duckdb, python
Status: published

I recently encountered an interview problem that involved answering various analytical questions over some number of delimited data files. 
Like many interview problems, the suggested solution hadn't been updated in a while (years), and was looking for a bespoke Python solution. 
It mentioned running on a laptop, and asked the interviewee to consider scalability in terms of data volume and extensibility in terms of answering new questions.
My mind immediately went to DuckDB.

# Setup

I wanted to use non-proprietary data so that anybody could reproduce the results. So I downloaded this [credit card transaction data generator](https://github.com/namebrandon/Sparkov_Data_Generation). 
It generates data with plenty of interesting facets to exercise various queries. 
I generated 4 data sets. 
The raw data is in csv files and takes up the following disk space:
```bash
➜ du -h data_*
31G     data_100mm_txn
3.1G    data_10mm_txn
314M    data_1mm_txn
62G     data_200mm_txn
```
a sample of one file:
```
➜ head data_1mm_txn/adults_2550_female_rural_0000-0239.csv
ssn|cc_num|first|last|gender|street|city|state|zip|lat|long|city_pop|job|dob|acct_num|profile|trans_num|trans_date|trans_time|unix_time|category|amt|is_fraud|merchant|merch_lat|merch_long
405-64-0484|6525324472099933|Maria|Porter|F|14626 Dawn Union Apt. 806|Smithers|WV|25186|38.1543|-81.278|881|Mechanical engineer|1999-03-18|599060683120|adults_2550_female_rural.json|bdadffbae7329592393b079c5827490e|2023-08-01|01:34:03|1690871643|grocery_pos|370.53|1|fraud_Kovacek, Dibbert and Ondricka|38.283713|-80.810153
405-64-0484|6525324472099933|Maria|Porter|F|14626 Dawn Union Apt. 806|Smithers|WV|25186|38.1543|-81.278|881|Mechanical engineer|1999-03-18|599060683120|adults_2550_female_rural.json|629fbb975c2ee41a9345f01afba7e6cf|2023-08-01|01:24:17|1690871057|misc_net|339.88|1|fraud_Kuphal-Predovic|37.196506|-81.913850
405-64-0484|6525324472099933|Maria|Porter|F|14626 Dawn Union Apt. 806|Smithers|WV|25186|38.1543|-81.278|881|Mechanical engineer|1999-03-18|599060683120|adults_2550_female_rural.json|b78ba4de847d0adfd821c6ccfe261477|2023-08-01|02:39:52|1690875592|misc_pos|873.23|1|fraud_Eichmann-Russel|37.519118|-81.765044
405-64-0484|6525324472099933|Maria|Porter|F|14626 Dawn Union Apt. 806|Smithers|WV|25186|38.1543|-81.278|881|Mechanical engineer|1999-03-18|599060683120|adults_2550_female_rural.json|6aac07c0b9182547c34676ab24b32a81|2023-08-01|01:07:41|1690870061|shopping_pos|933.84|1|fraud_Beier-Hyatt|38.361891|-81.390966
405-64-0484|6525324472099933|Maria|Porter|F|14626 Dawn Union Apt. 806|Smithers|WV|25186|38.1543|-81.278|881|Mechanical engineer|1999-03-18|599060683120|adults_2550_female_rural.json|a5cd41f69faaeffe2a0a3a7b58918e3b|2023-08-01|11:26:02|1690907162|shopping_net|1077.35|1|fraud_Kerluke-Abshire|38.148218|-81.294663
405-64-0484|6525324472099933|Maria|Porter|F|14626 Dawn Union Apt. 806|Smithers|WV|25186|38.1543|-81.278|881|Mechanical engineer|1999-03-18|599060683120|adults_2550_female_rural.json|ec72a087177503da0a5eee37e1d236e8|2023-08-01|01:12:46|1690870366|grocery_pos|838.74|1|fraud_Doyle Ltd|37.900884|-81.505876
405-64-0484|6525324472099933|Maria|Porter|F|14626 Dawn Union Apt. 806|Smithers|WV|25186|38.1543|-81.278|881|Mechanical engineer|1999-03-18|599060683120|adults_2550_female_rural.json|39cb621398e00c3059e1bf3d4527fcb3|2023-08-02|20:51:54|1691027514|shopping_pos|1002.48|1|fraud_Friesen Inc|38.328737|-81.958906
405-64-0484|6525324472099933|Maria|Porter|F|14626 Dawn Union Apt. 806|Smithers|WV|25186|38.1543|-81.278|881|Mechanical engineer|1999-03-18|599060683120|adults_2550_female_rural.json|5707a4463909b44faf5c62740e70ba4a|2023-08-02|21:23:06|1691029386|health_fitness|577.38|1|fraud_Greenholt Ltd|37.390618|-80.675238
405-64-0484|6525324472099933|Maria|Porter|F|14626 Dawn Union Apt. 806|Smithers|WV|25186|38.1543|-81.278|881|Mechanical engineer|1999-03-18|599060683120|adults_2550_female_rural.json|9af5738414987cc043e504067843ad61|2023-08-02|23:49:09|1691038149|kids_pets|585.89|1|fraud_Bernier and Sons|37.342443|-80.712102
```
These datasets are significantly wider than the data described in the original problem.

# Data Exploration
The first advantage these libraries have is how quickly you can get to something useful. DuckDB can directly run SQL over a set of CSV files.
```bash
➜ duckdb -c "SELECT * FROM 'data_1mm_txn/*adults_*.csv' LIMIT 10;"
┌─────────────┬─────────────────┬─────────┬─────────┬─────────┬─────────────────────┬───────────┬───┬────────────┬──────────────┬────────┬──────────┬──────────────────────┬───────────┬────────────┐
│     ssn     │     cc_num      │  first  │  last   │ gender  │       street        │   city    │ … │ unix_time  │   category   │  amt   │ is_fraud │       merchant       │ merch_lat │ merch_long │
│   varchar   │      int64      │ varchar │ varchar │ boolean │       varchar       │  varchar  │   │   int64    │   varchar    │ double │  int64   │       varchar        │  double   │   double   │
├─────────────┼─────────────────┼─────────┼─────────┼─────────┼─────────────────────┼───────────┼───┼────────────┼──────────────┼────────┼──────────┼──────────────────────┼───────────┼────────────┤
│ 424-64-6205 │ 371793271040546 │ Tiffany │ Jones   │ false   │ 2181 Wheeler Ridges │ Good Hope │ … │ 1682148836 │ grocery_pos  │   5.83 │        1 │ fraud_Cole PLC       │ 33.084605 │  -84.59263 │
│ 424-64-6205 │ 371793271040546 │ Tiffany │ Jones   │ false   │ 2181 Wheeler Ridges │ Good Hope │ … │ 1682147498 │ grocery_pos  │ 329.81 │        1 │ fraud_Stracke-Lemke  │ 32.909412 │ -83.336348 │
│ 424-64-6205 │ 371793271040546 │ Tiffany │ Jones   │ false   │ 2181 Wheeler Ridges │ Good Hope │ … │ 1682150282 │ misc_net     │ 341.76 │        1 │ fraud_Kuhn LLC       │ 32.869572 │ -84.365167 │
│ 424-64-6205 │ 371793271040546 │ Tiffany │ Jones   │ false   │ 2181 Wheeler Ridges │ Good Hope │ … │ 1682146929 │ shopping_net │ 832.34 │        1 │ fraud_Kuhic LLC      │ 33.540181 │ -83.670669 │
│ 424-64-6205 │ 371793271040546 │ Tiffany │ Jones   │ false   │ 2181 Wheeler Ridges │ Good Hope │ … │ 1682139650 │ grocery_net  │ 915.86 │        1 │ fraud_Swift, Bradt…  │ 34.058672 │ -83.259417 │
│ 424-64-6205 │ 371793271040546 │ Tiffany │ Jones   │ false   │ 2181 Wheeler Ridges │ Good Hope │ … │ 1682151402 │ misc_pos     │ 915.74 │        1 │ fraud_Gutmann-Upton  │  33.45225 │ -82.707481 │
│ 424-64-6205 │ 371793271040546 │ Tiffany │ Jones   │ false   │ 2181 Wheeler Ridges │ Good Hope │ … │ 1682306219 │ food_dining  │ 552.77 │        1 │ fraud_O'Hara-Wilde…  │ 33.054957 │ -83.575527 │
│ 424-64-6205 │ 371793271040546 │ Tiffany │ Jones   │ false   │ 2181 Wheeler Ridges │ Good Hope │ … │ 1682305693 │ home         │ 120.65 │        1 │ fraud_Reilly LLC     │ 33.433593 │ -83.425256 │
│ 424-64-6205 │ 371793271040546 │ Tiffany │ Jones   │ false   │ 2181 Wheeler Ridges │ Good Hope │ … │ 1682288784 │ food_dining  │ 107.78 │        1 │ fraud_Koss, McLaug…  │ 34.060598 │  -83.46855 │
│ 424-64-6205 │ 371793271040546 │ Tiffany │ Jones   │ false   │ 2181 Wheeler Ridges │ Good Hope │ … │ 1682308774 │ food_dining  │ 140.22 │        1 │ fraud_Powlowski-We…  │ 34.303291 │ -82.917523 │
├─────────────┴─────────────────┴─────────┴─────────┴─────────┴─────────────────────┴───────────┴───┴────────────┴──────────────┴────────┴──────────┴──────────────────────┴───────────┴────────────┤
│ 10 rows                                                                                                                                                                     26 columns (14 shown) │
└───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```